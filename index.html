<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poké-Dispensador</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <br><br><br>
  <div id="bienvenida">
    <p>La Licenciatura en Tecnologías de la Información los invita a participar en está actividad para poner a prueba sus
      conocimientos sobre los Pokémon más populares. ¡Adivina el nombre del Pokémon y gana un premio!, para más Información
    de nuestra carrera visita nuestro sitio web dando clic en este 
    <a href="https://uaeh.edu.mx/campus/tizayuca/tecnologias_informacion/campo-laboral.html">enlace</a>.</p>
    <img src="/img/uaeh.png" alt="UAEH" id="logo-uaeh" class="logo-uaeh">
  </div>
  <br><br>
  <div class="card">
    <div class="row">
      <div>
        <h1>Poké-Dispensador</h1>
        <div class="muted">Acierta el nombre: si aciertas, recibirás un premio</div>
      </div>
      <button id="btnNuevo">Nuevo Pokémon</button>
    </div>

    <div id="poke" class="poke">
      <img id="pokeImg" alt="Pokémon">
      <div>
        <div id="pokeId" class="muted"></div>
        <div style="margin-top:4px">¿Cómo se llama?</div>
      </div>
    </div>

    <div id="options" class="grid"></div>
    <div id="status">Listo. Presiona “Nuevo Pokémon”.</div>
  </div>

  <script>

    const ESP32_BASE_URL = "http://192.168.137.80"; //ip del esp32

    const MAX_POKE = 898; 
    const btnNuevo = document.getElementById('btnNuevo');
    const statusEl = document.getElementById('status');
    const poke = document.getElementById('poke');
    const pokeImg = document.getElementById('pokeImg');
    const pokeId = document.getElementById('pokeId');
    const optionsEl = document.getElementById('options');

    let correct = null, loading = false;

    function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    async function getPokemon(id) {
      const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
      if (!r.ok) throw new Error('PokeAPI');
      return r.json();
    }
    function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' '); }

    async function nuevo() {
      if (loading) return; loading = true; btnNuevo.disabled = true;
      optionsEl.innerHTML = ''; poke.style.display = 'none'; statusEl.textContent = 'Cargando Pokémon…';
      try {
        const id = r(1, MAX_POKE);
        const d = await getPokemon(id);
        correct = d.name;

        const sprite = d.sprites?.other?.['official-artwork']?.front_default || d.sprites?.front_default || "";
        pokeImg.src = sprite; pokeImg.alt = d.name;
        pokeId.textContent = `#${String(id).padStart(3, '0')}`;
        poke.style.display = 'flex';

        const names = new Set([d.name]);
        while (names.size < 4) {
          const rid = r(1, MAX_POKE); if (rid === id) continue;
          try { names.add((await getPokemon(rid)).name); } catch { }
        }
        [...names].sort(() => Math.random() - 0.5).forEach(n => {
          const b = document.createElement('button');
          b.className = 'opt'; b.textContent = cap(n); b.onclick = () => answer(n, b);
          optionsEl.appendChild(b);
        });
        statusEl.textContent = 'Elige una opción.';
      } catch (e) {
        console.error(e); statusEl.textContent = 'No pude cargar el Pokémon. Intenta de nuevo.';
      } finally {
        btnNuevo.disabled = false; loading = false;
      }
    }

    async function answer(sel, btn) {
      document.querySelectorAll('.opt').forEach(o => o.disabled = true);

      if (sel === correct) { 
        btn.classList.add('ok');
        statusEl.textContent = '¡Correcto! Soltando 1 dulce…';

        // Mostrar modal al acertar
        mostrarModalAcierto();

        try {
            const esp32Url = 'http://192.168.137.80/dispense';
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const r = await fetch(esp32Url, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json();
            console.log('Respuesta ESP32:', data);
            statusEl.textContent = '¡Hecho! ¡Dulce dispensado! ';
        } catch (e) {
            console.error('Error ESP32:', e);
            if (e.name === 'AbortError') {
                statusEl.textContent = 'Acertaste, pero el dispensador no responde (timeout).';
            } else {
                statusEl.textContent = 'Acertaste, pero no pude comunicarme con el dispensador.';
            }
        }

      } else {
        btn.classList.add('bad');
        statusEl.textContent = 'Incorrecto. No hay dulce esta vez.';
      }
    }

    btnNuevo.addEventListener('click', nuevo);

    // Función del modal
    function mostrarModalAcierto() {
        const modal = document.getElementById("modal-acierto");
        modal.style.display = "flex";

        document.getElementById("cerrarModal").onclick = () => {
            modal.style.display = "none";
        };

        modal.onclick = (e) => {
          if (e.target.id === "modal-acierto") modal.style.display = "none";
        };
    }

  </script>

  <!-- MODAL DE ACIERTO -->
  <div id="modal-acierto" class="modal-traslape">
      <div class="modal-contenido">
          <img src="icons/192.png" class="modal-icono" alt="Pokebola">
          <h2>¡Correcto!</h2>
          <p>¡Adivinaste el Pokémon!</p>
          <button id="cerrarModal">Cerrar</button>
      </div>
  </div>

  <style>
    .modal-traslape {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.55);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .modal-contenido {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(5px);
        text-align: center;
        padding: 25px;
        border-radius: 12px;
        width: 80%;
        max-width: 350px;
        animation: pop 0.3s ease;
    }

    .modal-icono {
        width: 80px;
        margin-bottom: 15px;
    }

    #cerrarModal {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        background: #ffcb05;
        border-radius: 6px;
        cursor: pointer;
    }

    @keyframes pop {
        0% { transform: scale(0.7); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }
  </style>

</body>
</html>
